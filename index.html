<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPD读写工具</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 自定义滚动条样式 */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c5c5c5;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app">
    <!-- Toast 提示 -->
    <div v-if="toastMsg" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-md shadow-lg z-50 transition-opacity duration-300">
      {{ toastMsg }}
    </div>
    
    <!-- 端口选择对话框 -->
    <div v-if="showPortDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
        <div class="p-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-800">{{ t('selectPort') }}</h3>
        </div>
        <div class="p-4 max-h-80 overflow-y-auto">
          <ul class="divide-y divide-gray-200">
            <li v-for="(p, idx) in availablePorts" :key="idx"
                class="py-3 px-4 hover:bg-blue-50 cursor-pointer transition-colors"
                :class="{'bg-blue-100': selectedPortIndex === idx}"
                @click="connectToPort(p)">
              <div class="font-medium text-gray-800">{{ getPortDisplayName(p, idx) }}</div>
            </li>
          </ul>
        </div>
        <div class="p-4 border-t border-gray-200 flex justify-end">
          <button @click="showPortDialog = false" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
            {{ t('cancel') }}
          </button>
        </div>
      </div>
    </div>
    
    <div class="min-h-screen flex flex-col">
      
      <!-- 控制面板 -->
      <div class="bg-white border-b border-gray-200 p-4">
        <!-- 状态和按钮 -->
        <div class="flex flex-wrap items-center gap-3 mb-4">
          <div class="flex-1 min-w-[200px] bg-gray-100 rounded-lg px-4 py-2 flex items-center">
            <span class="text-gray-700 mr-2">{{ t('status') }}:</span>
            <span :class="{'text-green-600': portOpen, 'text-red-600': !portOpen}">
              {{ portOpen ? t('connected') : t('disconnected') }}
            </span>
          </div>
          
          <button @click="openPort" :disabled="portOpen" 
            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed transition-colors">
            {{ t('connect') }}
          </button>
          
          <button @click="closePort" :disabled="!portOpen"
            class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
            {{ t('disconnect') }}
          </button>
          
          <button @click="lang = lang === 'zh' ? 'en' : 'zh'" 
            class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition-colors">
            {{ lang === 'zh' ? 'English' : '中文' }}
          </button>
        </div>
        
        <!-- 表单 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-4">
          <div class="space-y-1">
            <label for="spdaddr" class="block text-sm font-medium text-gray-700">{{ t('spdaddr') }}</label>
            <select id="spdaddr" v-model="formData.spdaddr" :disabled="!portOpen"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100">
              <option v-for="n in 8" :value="50 + n - 1">{{ 50 + n - 1 }}</option>
            </select>
          </div>
          
          <div class="space-y-1">
            <label for="type" class="block text-sm font-medium text-gray-700">{{ t('type') }}</label>
            <select id="type" v-model="formData.type" :disabled="!portOpen"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100">
              <option value="ddr5">DDR5</option>
              <option value="ddr4">DDR4</option>
              <option value="ddr3">DDR3</option>
            </select>
          </div>
          
          <div class="space-y-1">
            <label for="cmd" class="block text-sm font-medium text-gray-700">{{ t('cmd') }}</label>
            <select id="cmd" v-model="formData.cmd" :disabled="!portOpen"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100">
              <option value="read">{{ t('read') }}</option>
              <option value="write">{{ t('write') }}</option>
              <option value="srswp">{{ t('srswp') }}</option>
            </select>
          </div>
          
          <div class="space-y-1">
            <label for="addr" class="block text-sm font-medium text-gray-700">{{ t('addr') }}</label>
            <input id="addr" type="text" v-model="formData.addr" :disabled="!portOpen" placeholder="00"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100">
          </div>
          
          <div class="space-y-1" v-if="formData.cmd === 'read'">
            <label for="number" class="block text-sm font-medium text-gray-700">{{ t('number') }}</label>
            <input id="number" type="text" v-model="formData.number" :disabled="!portOpen" placeholder="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100">
          </div>
          
          <div class="flex items-end space-x-2">
            <button @click="sendMessage" :disabled="!portOpen"
              class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 disabled:bg-green-300 disabled:cursor-not-allowed transition-colors">
              {{ t('send') }}
            </button>
            <button @click="clearReceivedData"
              class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
              {{ t('clear') }}
            </button>
          </div>
        </div>
        
        <!-- 额外选项 -->
        <div v-if="formData.cmd === 'write' || formData.cmd === 'srswp'" class="mt-2">
          <div class="flex items-end space-x-2">
            <div class="flex-1 space-y-1">
              <label for="value" class="block text-sm font-medium text-gray-700">{{ t('value') }}</label>
              <input id="value" type="text" v-model="formData.value" :disabled="!portOpen" placeholder=""
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100">
            </div>
          </div>
        </div>
        
        <!-- 最近发送的数据 -->
        <div v-if="lastSentData" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-md">
          <div class="flex items-start">
            <strong class="text-green-800 mr-2">{{ t('lastSend') }}:</strong>
            <span class="text-green-700 font-mono text-sm break-all">{{ compressedSentData }}</span>
          </div>
        </div>
      </div>
      
      <!-- 内容区域 -->
      <div class="flex-1 overflow-hidden">
        <div class="h-full p-4">
          <div class="bg-white rounded-lg border border-gray-200 h-full flex flex-col">
            <div class="px-4 py-3 border-b border-gray-200">
              <h3 class="text-lg font-medium text-gray-800">{{ t('received') }}</h3>
            </div>
            <div class="flex-1 p-4 overflow-auto custom-scrollbar">
              <pre class="font-mono text-sm text-gray-800 whitespace-pre-wrap break-words">{{ receivedData }}</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, onMounted, onBeforeUnmount, watch, nextTick, computed } = Vue;
    
    createApp({
      setup() {
        // 串口相关状态
        const portOpen = ref(false);
        const receivedData = ref('');
        const lastSentData = ref('');
        const error = ref(null);
        const toastMsg = ref('');
        let port = null;
        let reader = null;
        let readableStreamClosed = null;

        // 弹窗相关状态
        const showPortDialog = ref(false);
        const availablePorts = ref([]);
        const selectedPortIndex = ref(null);

        // 表单数据
        const formData = ref({
          spdaddr: "50",
          type: "ddr5",
          cmd: "read",
          addr: "0",
          value: "",
          number: "3"
        });
        
        watch(
          () => formData.value.cmd,
          (newCmd) => {
            if (newCmd === 'read') {
              formData.value.addr = '0';
              formData.value.number = '3';
              formData.value.value = '';
            } else if (newCmd === 'write' || newCmd === 'srswp') {
              formData.value.addr = '0';
              formData.value.value = '';
              formData.value.number = '';
            }
          }
        );

        let timer = null;

        // 压缩发送数据显示
        const compressedSentData = computed(() => {
          return lastSentData.value || '';
        });

        // 清空接收区
        const clearReceivedData = () => {
          receivedData.value = '';
        };

        // toast 弹窗
        function showToast(msg) {
          toastMsg.value = msg;
          setTimeout(() => { toastMsg.value = ''; }, 2200);
        }

        // 连接已选串口
        const connectToPort = async (selectedPort) => {
          try {
            port = selectedPort;
            await port.open({
              baudRate: 115200,
              dataBits: 8,
              stopBits: 1,
              parity: 'none'
            });
            portOpen.value = true;
            receivedData.value = t('serialConnectedWait') + '\n';
            error.value = null;
            showToast(t('toastConnected'));
            showPortDialog.value = false;
            readData();
          } catch (err) {
            error.value = `${t('openError')}: ${err.message}`; 
            showToast(error.value);
          }
        };

        // 打开串口
        const openPort = async () => {
          try {
            if (!('serial' in navigator)) {
              showToast(t('toastNotSupport'));
              throw new Error('您的浏览器不支持Web Serial API');
            }
            
            const ports = await navigator.serial.getPorts();
            if (ports.length === 0) {
              port = await navigator.serial.requestPort();
              await connectToPort(port);
            } else {
              availablePorts.value = ports;
              selectedPortIndex.value = null;
              showPortDialog.value = true;
            }
          } catch (err) {
            error.value = `${t('openError')}: ${err.message}`;
            showToast(error.value);
          }
        };

        // 关闭串口
        const closePort = async () => {
          try {
            if (reader) {
              try {
                await reader.cancel();
              } catch (cancelError) {
                console.warn('取消读取器时出错:', cancelError);
              }
              
              if (reader && typeof reader.releaseLock === 'function') {
                reader.releaseLock();
              }
              reader = null;
            }
            
            if (readableStreamClosed) {
              try {
                await readableStreamClosed.catch(() => {});
              } catch (streamError) {
                console.warn('关闭流时出错:', streamError);
              }
              readableStreamClosed = null;
            }
            
            if (port) {
              try {
                await port.close();
              } catch (closeError) {
                error.value = `${t('closeError')}: ${closeError.message}`;
                showToast(error.value);
                throw closeError;
              } finally {
                port = null;
              }
            }
            
            portOpen.value = false;
            receivedData.value += t('serialDisconnected') + '\n';
            error.value = null;
            showToast(t('toastDisconnected'));
          } catch (err) {
            error.value = `${t('closeError')}: ${err.message}`;
            showToast(error.value);
            portOpen.value = false;
            port = null;
            reader = null;
            readableStreamClosed = null;
          }
        };

        // 读取串口数据
        const readData = async () => {
          try {
            const decoder = new TextDecoderStream();
            readableStreamClosed = port.readable.pipeTo(decoder.writable);
            reader = decoder.readable.getReader();
            
            while (portOpen.value) {
              try {
                const { value, done } = await reader.read();
                if (done) {
                  break;
                }
                receivedData.value += value;
                await nextTick();
                const container = document.querySelector('.custom-scrollbar');
                if (container) container.scrollTop = container.scrollHeight;
              } catch (readError) {
                if (readError.name !== 'InterruptedError') {
                  error.value = `${t('readError')}: ${readError.message}`;
                  showToast(error.value);
                  throw readError;
                }
                break;
              }
            }
          } catch (err) {
            error.value = `${t('readError')}: ${err.message}`;
            showToast(error.value);
            closePort();
          }
        };

        // 发送消息
        const sendMessage = async () => {
          if (!port || !portOpen.value) return;
          
          // 表单验证
          if ((formData.value.cmd === 'read' || formData.value.cmd === 'write')) {
            if (!formData.value.addr || !/^[0-9a-fA-F]+$/.test(formData.value.addr)) {
              showToast(t('addrHexRequired'));
              return;
            }
          }
          
          if (formData.value.cmd === 'read') {
            if (!formData.value.number || !/^[0-9]+$/.test(formData.value.number)) {
              showToast(t('numberDecRequired'));
              return;
            }
          }
          
          if ((formData.value.cmd === 'write' || formData.value.cmd === 'srswp')) {
            if (!formData.value.value || !/^[0-9a-fA-F]+$/.test(formData.value.value)) {
              showToast(t('valueHexRequired'));
              return;
            }
          }
          
          let writer = null;
          try {
            receivedData.value = '';
            const encoder = new TextEncoder();
            writer = port.writable.getWriter();
            
            const dataToSend = {
              spdaddr: formData.value.spdaddr,
              type: formData.value.type,
              cmd: formData.value.cmd,
              addr: formData.value.addr,
              value: formData.value.value,
              number: formData.value.number
            };
            
            const jsonString = JSON.stringify(dataToSend, null, 2);
            lastSentData.value = jsonString;
            await writer.write(encoder.encode(jsonString + '\n'));
          } catch (err) {
            error.value = `${t('sendError')}: ${err.message}`;
            showToast(error.value);
            closePort();
          } finally {
            if (writer && typeof writer.releaseLock === 'function') writer.releaseLock();
          }
        };

        // 获取串口显示名称
        function getPortDisplayName(p, idx) {
          if (p.getInfo) {
            const info = p.getInfo();
            if (info.usbVendorId && info.usbProductId) {
              return `VID:${info.usbVendorId.toString(16).toUpperCase()} PID:${info.usbProductId.toString(16).toUpperCase()}`;
            }
          }
          return t('unknownDevice');
        }

        // 组件卸载时关闭串口和定时器
        onBeforeUnmount(() => {
          if (timer) clearInterval(timer);
          if (portOpen.value) closePort();
        });

        // 语言切换与国际化
        const lang = ref('zh');
        const i18n = {
          zh: {
            status: '状态',
            connected: '已连接',
            disconnected: '未连接',
            connect: '连接串口',
            disconnect: '断开连接',
            spdaddr: 'SPD地址',
            type: '类型',
            cmd: '命令',
            addr: '地址',
            number: '数量',
            value: '值',
            send: '发送',
            clear: '清空接收区',
            lastSend: '最近发送',
            received: '接收数据',
            selectPort: '请选择已授权串口',
            cancel: '取消',
            toastNotSupport: '您的浏览器不支持Web Serial API，仅支持新版Chrome/Edge',
            toastConnected: '串口已连接',
            toastDisconnected: '串口已断开',
            read: '读取',
            write: '写入',
            srswp: '设置写保护',
            serialConnectedWait: '串口已连接，等待数据...\n',
            serialDisconnected: '串口已断开\n',
            addrHexRequired: '地址必须为16进制且不能为空',
            numberDecRequired: '数量必须为10进制数字且不能为空',
            valueHexRequired: '值必须为16进制且不能为空',
            unknownDevice: '未知设备',
            openError: '打开错误',
            closeError: '关闭错误',
            sendError: '发送错误',
            readError: '读取错误'
          },
          en: {
            status: 'Status',
            connected: 'Connected',
            disconnected: 'Disconnected',
            connect: 'Connect Serial',
            disconnect: 'Disconnect',
            spdaddr: 'SPD Address',
            type: 'Type',
            cmd: 'Command',
            addr: 'Address',
            number: 'Number',
            value: 'Value',
            send: 'Send',
            clear: 'Clear',
            lastSend: 'Last Sent',
            received: 'Received Data',
            selectPort: 'Select Authorized Serial Port',
            cancel: 'Cancel',
            toastNotSupport: 'Your browser does not support Web Serial API. Please use latest Chrome/Edge.',
            toastConnected: 'Serial port connected',
            toastDisconnected: 'Serial port disconnected',
            read: 'Read',
            write: 'Write',
            srswp: 'Set Write Protect',
            serialConnectedWait: 'Serial port connected, waiting for data...\n',
            serialDisconnected: 'Serial port disconnected\n',
            addrHexRequired: 'Address must be non-empty and hexadecimal',
            numberDecRequired: 'Number must be non-empty and decimal',
            valueHexRequired: 'Value must be non-empty and hexadecimal',
            unknownDevice: 'Unknown Device',
            openError: 'Open Error',
            closeError: 'Close Error',
            sendError: 'Send Error',
            readError: 'Read Error'
          }
        };
        
        function t(key) {
          return i18n[lang.value][key] || key;
        }

        return {
          portOpen,
          receivedData,
          lastSentData,
          error,
          formData,
          openPort,
          closePort,
          sendMessage,
          clearReceivedData,
          toastMsg,
          showPortDialog,
          availablePorts,
          selectedPortIndex,
          connectToPort,
          getPortDisplayName,
          lang,
          t,
          compressedSentData
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
